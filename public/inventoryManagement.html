<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediConnect - Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      /* Custom animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .inventory-item {
        animation: slideIn 0.3s ease-out;
      }

      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* Sort indicators */
      th .sort-arrow {
        color: #aaa;
        visibility: hidden;
        margin-left: 6px;
        font-size: 0.75rem;
      }

      th.sorted .sort-arrow {
        visibility: visible;
        color: #22c55e;
      }

      th.sortable {
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
      }

      th.sortable:hover {
        background-color: #f3f4f6;
        color: #3b82f6;
      }

      th.sorted {
        background-color: #eff6ff;
        font-weight: 600;
      }

      /* Status indicators */
      .status-expired {
        background-color: #fecaca !important;
      }
      .status-expiring {
        background-color: #d1d5db !important;
      }
      .status-low-stock {
        background-color: #fef3c7 !important;
      }

      /* Enhanced buttons */
      .btn-action {
        transition: all 0.2s ease;
        transform: translateY(0);
      }

      .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 to-indigo-100 text-[#001F3F] font-sans flex flex-col min-h-screen"
  >
    <!-- Navbar -->
    <nav class="bg-white text-black shadow-lg p-4 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a
          href="clinicDashboard.html"
          class="hover:scale-105 transition-transform"
        >
          <img src="media/logo2.png" alt="MediConnect Logo" class="h-20 w-21" />
        </a>
        <div class="hidden md:flex space-x-6">
          <a href="clinicDashboard.html" class="hover:text-blue-600 transition"
            >Dashboard</a
          >
          <a
            href="appointmentManagement.html"
            class="hover:text-blue-600 transition"
            >Appointments</a
          >
          <a
            href="inventoryManagement.html"
            class="hover:text-blue-600 transition font-semibold border-b-2 border-blue-500"
            >Inventory</a
          >
          <a
            href="reporting&analytics.html"
            class="hover:text-blue-600 transition"
            >Reports</a
          >
          <a href="staff_add_tip.html" class="hover:text-blue-600 transition"
            >Add Tips</a
          >
        </div>
        <div class="relative text-sm">
          <span id="userName" class="mr-2 font-medium">Clinic Admin</span>
          <button
            id="profileBtn"
            class="bg-blue-400 text-white rounded-full w-8 h-8 font-bold hover:bg-blue-600 transition-all hover:scale-105"
          >
            MC
          </button>
          <div
            class="absolute right-0 mt-2 w-48 bg-white text-[#001F3F] rounded-lg shadow-xl border hidden"
            id="profileDropdown"
          >
            <a
              href="staffProfile.html"
              class="block px-4 py-2 hover:bg-blue-50 rounded-t-lg transition"
              >Profile Settings</a
            >
            <a
              href="#"
              id="logoutBtn"
              class="block px-4 py-2 text-red-600 hover:bg-red-50 rounded-b-lg transition"
              >Logout</a
            >
          </div>
        </div>
      </div>
    </nav>

    <!-- Notification Containers -->
    <div
      id="errorContainer"
      class="hidden fixed top-4 right-4 max-w-sm bg-red-500 text-white text-sm rounded-xl shadow-lg p-4 flex items-start gap-3 z-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 shrink-0 mt-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span id="errorMessage">Something went wrong</span>
    </div>

    <div
      id="successContainer"
      class="hidden fixed top-4 right-4 max-w-sm bg-green-500 text-white text-sm rounded-xl shadow-lg p-4 flex items-start gap-3 z-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 shrink-0 mt-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        />
      </svg>
      <span id="successMessage">Action completed successfully</span>
    </div>

    <!-- Main -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <!-- Page Header -->
        <div class="text-center mb-10">
          <h1 class="text-4xl font-bold text-[#001F3F] mb-2">
            Medical Inventory Management
          </h1>
          <p class="text-gray-600">
            Track inventory levels, expiration dates, and usage logs
          </p>
        </div>

        <!-- Quick Actions -->
        <div
          class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4"
        >
          <div class="flex gap-4">
            <a
              href="addStock.html"
              class="btn-action bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-all font-semibold tracking-wide inline-flex items-center"
            >
              <svg
                class="w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                ></path>
              </svg>
              Add Item
            </a>
            <button
              id="refreshBtn"
              class="btn-action bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all font-semibold tracking-wide inline-flex items-center"
            >
              <svg
                class="w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
              Refresh
            </button>
          </div>

          <button
            id="toggleExpiredBtn"
            class="btn-action bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all font-semibold tracking-wide"
          >
            Show Expired Only
          </button>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-md p-6 border border-blue-200">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                  ></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-2xl font-bold text-gray-800" id="totalCount">
                  0
                </p>
                <p class="text-gray-600">Total Items</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-md p-6 border border-red-200">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-red-100 text-red-600">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-2xl font-bold text-red-600" id="expiredCount">
                  0
                </p>
                <p class="text-gray-600">Expired Items</p>
              </div>
            </div>
          </div>

          <div
            class="bg-white rounded-xl shadow-md p-6 border border-yellow-200"
          >
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"
                  ></path>
                </svg>
              </div>
              <div class="ml-4">
                <p
                  class="text-2xl font-bold text-yellow-600"
                  id="lowStockCount"
                >
                  0
                </p>
                <p class="text-gray-600">Low Stock Items</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-gray-100 text-gray-600">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <div class="ml-4">
                <p
                  class="text-2xl font-bold text-gray-600"
                  id="expiringSoonCount"
                >
                  0
                </p>
                <p class="text-gray-600">Expiring Soon</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Search and Filter -->
        <div
          class="bg-white rounded-xl shadow-md p-6 mb-8 border border-blue-200"
        >
          <div class="flex flex-col lg:flex-row gap-4">
            <div class="flex-1">
              <input
                id="searchInventory"
                type="text"
                placeholder="Search items by name, category..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              />
            </div>
            <select
              id="filterCategory"
              class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            >
              <option value="">All Categories</option>
              <option value="Equipment">Equipment</option>
              <option value="Medication">Medication</option>
              <option value="PPE">PPE</option>
              <option value="Consumables">Consumables</option>
              <option value="Other">Other</option>
            </select>
            <select
              id="sortBy"
              class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            >
              <option value="item_name">Sort by Name</option>
              <option value="quantity">Sort by Quantity</option>
              <option value="expiry_date">Sort by Expiry</option>
              <option value="category">Sort by Category</option>
            </select>
          </div>
        </div>

        <!-- Inventory Table -->
        <div
          class="bg-white rounded-xl shadow-md border border-blue-200 overflow-hidden mb-8"
        >
          <div class="p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-[#001F3F] flex items-center">
              <svg
                class="w-7 h-7 mr-3 text-blue-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
              Current Inventory
            </h2>
          </div>

          <div class="overflow-x-auto custom-scrollbar">
            <table class="min-w-full text-sm text-left text-[#001F3F]">
              <thead class="bg-gray-50 text-gray-700 border-b border-gray-200">
                <tr>
                  <th
                    class="py-4 px-6 sortable"
                    onclick="sortInventory('item_name')"
                  >
                    Item Name <span class="sort-arrow">▲</span>
                  </th>
                  <th
                    class="py-4 px-6 sortable"
                    onclick="sortInventory('quantity')"
                  >
                    Quantity <span class="sort-arrow">▲</span>
                  </th>
                  <th
                    class="py-4 px-6 sortable"
                    onclick="sortInventory('expiry_date')"
                  >
                    Expiry Date <span class="sort-arrow">▲</span>
                  </th>
                  <th
                    class="py-4 px-6 sortable"
                    onclick="sortInventory('category')"
                  >
                    Category <span class="sort-arrow">▲</span>
                  </th>
                  <th
                    class="py-4 px-6 sortable"
                    onclick="sortInventory('stock_limit')"
                  >
                    Stock Limit <span class="sort-arrow">▲</span>
                  </th>
                  <th class="py-4 px-6">Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="6" class="text-center py-12">
                    <div class="flex items-center justify-center">
                      <div
                        class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                      ></div>
                      <span class="ml-3 text-gray-600"
                        >Loading inventory...</span
                      >
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Stock Usage Log -->
        <div class="bg-white rounded-xl shadow-md border border-blue-200 p-6">
          <h3 class="text-2xl font-bold text-[#001F3F] mb-4 flex items-center">
            <svg
              class="w-7 h-7 mr-3 text-green-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
              ></path>
            </svg>
            Recent Activity Log
          </h3>
          <div class="max-h-64 overflow-y-auto custom-scrollbar">
            <ul id="stockLog" class="space-y-2 text-sm text-[#001F3F]">
              <li class="text-gray-500 italic">No recent activity</li>
            </ul>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 text-white text-center py-6 text-sm mt-10">
      <p>© 2025 MediConnect. All rights reserved.</p>
      <p>Email: campusclinic@ump.ac.za | Phone: +27 76 049 6387</p>
    </footer>

    <!-- Enhanced Confirm Modal -->
    <div
      id="confirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-96 p-6 text-center transform transition-all"
      >
        <div class="mb-4">
          <svg
            class="mx-auto h-16 w-16 text-red-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-4 text-gray-800" id="confirmMessage">
          Are you sure?
        </h2>
        <div class="flex justify-center gap-4">
          <button
            id="confirmYes"
            class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all font-semibold"
          >
            Yes, Continue
          </button>
          <button
            id="confirmNo"
            class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-all font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 transform transition-all"
      >
        <h2 class="text-xl font-bold mb-4 text-gray-800">Edit Item</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Item Name</label>
            <input
              type="text"
              id="editItemName"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Quantity</label>
            <input
              type="number"
              id="editQuantity"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Expiry Date</label>
            <input
              type="date"
              id="editExpiryDate"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Category</label>
            <select
              id="editCategory"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="Equipment">Equipment</option>
              <option value="Medication">Medication</option>
              <option value="PPE">PPE</option>
              <option value="Consumables">Consumables</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Stock Limit</label>
            <input
              type="number"
              id="editStockLimit"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-6">
          <button
            id="editCancel"
            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all"
          >
            Cancel
          </button>
          <button
            id="editSave"
            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all"
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <script>
      // Remove browser storage dependency and replace with in-memory storage
      function getToken() {
        try {
          return (
            sessionStorage.getItem("supabase_token") ||
            "mock_token_for_development"
          );
        } catch (error) {
          console.warn("SessionStorage not available, using mock token");
          return "mock_token_for_development";
        }
      }

      // Notification Functions
      function showError(message, duration = 4000) {
        const container = document.getElementById("errorContainer");
        const msg = document.getElementById("errorMessage");
        if (container && msg) {
          msg.textContent = message;
          container.classList.remove("hidden");
          setTimeout(() => container.classList.add("hidden"), duration);
        } else {
          console.error("Error:", message);
        }
      }

      function showSuccess(message, duration = 4000) {
        const container = document.getElementById("successContainer");
        const msg = document.getElementById("successMessage");
        if (container && msg) {
          msg.textContent = message;
          container.classList.remove("hidden");
          setTimeout(() => container.classList.add("hidden"), duration);
        } else {
          console.log("Success:", message);
        }
      }

      // Confirmation modal
      function showConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmModal");
          const messageEl = document.getElementById("confirmMessage");
          const yesBtn = document.getElementById("confirmYes");
          const noBtn = document.getElementById("confirmNo");

          if (!modal || !messageEl || !yesBtn || !noBtn) {
            resolve(confirm(message));
            return;
          }

          messageEl.textContent = message;
          modal.classList.remove("hidden");

          const handleYes = () => {
            modal.classList.add("hidden");
            yesBtn.removeEventListener("click", handleYes);
            noBtn.removeEventListener("click", handleNo);
            resolve(true);
          };

          const handleNo = () => {
            modal.classList.add("hidden");
            yesBtn.removeEventListener("click", handleYes);
            noBtn.removeEventListener("click", handleNo);
            resolve(false);
          };

          yesBtn.addEventListener("click", handleYes);
          noBtn.addEventListener("click", handleNo);
        });
      }

      // Inventory management
      let inventory = [];
      const stockLog = [];
      let currentSortField = "item_name";
      let currentSortDirection = "asc";
      let showExpiredOnly = false;

      // Mock data for development
      const mockInventory = [
        {
          id: 1,
          item_name: "Paracetamol Tablets",
          quantity: 150,
          expiry_date: "2025-06-15",
          category: "Medication",
          stock_limit: 50,
        },
        {
          id: 2,
          item_name: "Digital Thermometer",
          quantity: 8,
          expiry_date: "2027-12-31",
          category: "Equipment",
          stock_limit: 10,
        },
        {
          id: 3,
          item_name: "Face Masks",
          quantity: 25,
          expiry_date: "2024-08-30",
          category: "PPE",
          stock_limit: 100,
        },
        {
          id: 4,
          item_name: "Bandages",
          quantity: 75,
          expiry_date: "2026-03-20",
          category: "Consumables",
          stock_limit: 30,
        },
        {
          id: 5,
          item_name: "Hand Sanitizer",
          quantity: 12,
          expiry_date: "2025-01-15",
          category: "PPE",
          stock_limit: 20,
        },
      ];

      function sortInventory(field, toggle = true) {
        if (currentSortField === field) {
          if (toggle) {
            currentSortDirection =
              currentSortDirection === "asc" ? "desc" : "asc";
          }
        } else {
          currentSortField = field;
          currentSortDirection = "asc";
        }

        inventory.sort((a, b) => {
          let aValue = a[field];
          let bValue = b[field];

          if (typeof aValue === "string") aValue = aValue.toLowerCase();
          if (typeof bValue === "string") bValue = bValue.toLowerCase();

          if (aValue < bValue) return currentSortDirection === "asc" ? -1 : 1;
          if (aValue > bValue) return currentSortDirection === "asc" ? 1 : -1;
          return 0;
        });

        renderInventory();
        updateSortIndicators();
      }

      function updateSortIndicators() {
        const headers = document.querySelectorAll("th.sortable");
        headers.forEach((th) => {
          const span = th.querySelector(".sort-arrow");
          if (span) span.textContent = "▲";
          th.classList.remove("sorted");
        });

        const activeHeader = Array.from(headers).find((th) => {
          const fieldName = th.getAttribute("onclick").match(/'([^']+)'/)[1];
          return fieldName === currentSortField;
        });

        if (activeHeader) {
          const span = activeHeader.querySelector(".sort-arrow");
          if (span) {
            span.textContent = currentSortDirection === "asc" ? "▲" : "▼";
          }
          activeHeader.classList.add("sorted");
        }
      }

      async function fetchInventory() {
        try {
          console.log("Loading inventory...");
          const response = await fetch("http://localhost:5000/inventory/", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
          });

          if (response.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (response.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (response.status === 404) {
            window.location.href = "404.html";
            return;
          }

          const result = await response.json();
          inventory = result.inventory || [];
          allInventory = [...inventory]; // Store all items for filtering
          console.log("Inventory loaded from backend:", inventory);
        } catch (error) {
          console.warn(
            "Error loading inventory from backend, using mock data:",
            error
          );
          inventory = mockInventory;
          allInventory = [...mockInventory]; // Store all items for filtering
          showError("Using demo data - backend connection failed");
        }

        sortAndRender();
      }

      function renderInventory() {
        const tbody = document.getElementById("inventoryTableBody");
        tbody.innerHTML = "";

        const today = new Date();
        const soon = new Date();
        soon.setDate(today.getDate() + 7);

        // Calculate stats
        const totalCount = inventory.length;
        const expiredCount = inventory.filter(
          (item) => new Date(item.expiry_date) < today
        ).length;
        const lowStockCount = inventory.filter((item) => {
          const qty = Number(item.quantity);
          const limit = Number(item.stock_limit);
          return !isNaN(qty) && !isNaN(limit) && qty < limit;
        }).length;
        const expiringSoonCount = inventory.filter((item) => {
          const expDate = new Date(item.expiry_date);
          return expDate >= today && expDate <= soon;
        }).length;

        // Update stat cards
        document.getElementById("totalCount").textContent = totalCount;
        document.getElementById("expiredCount").textContent = expiredCount;
        document.getElementById("lowStockCount").textContent = lowStockCount;
        document.getElementById("expiringSoonCount").textContent =
          expiringSoonCount;

        // Filter items based on expired toggle
        const itemsToRender = showExpiredOnly
          ? inventory.filter((item) => new Date(item.expiry_date) < today)
          : inventory;

        if (!itemsToRender.length) {
          tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-12">
              <div class="text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4m16 0l-2-2m-2 2l2-2m0 0l-2-2m2 2l2 2M8 13V9"></path>
                </svg>
                <p class="text-lg font-medium">${
                  showExpiredOnly
                    ? "No expired items found"
                    : "No inventory items available"
                }</p>
                <p class="text-sm">Add some items to get started!</p>
              </div>
            </td>
          </tr>
        `;
          return;
        }

        itemsToRender.forEach((item) => {
          const expDate = new Date(item.expiry_date);
          const quantity = Number(item.quantity);
          const stockLimit = Number(item.stock_limit);

          let rowClass = "inventory-item";
          let statusBadge = "";

          // Determine row status and styling
          if (expDate < today) {
            rowClass += " status-expired";
            statusBadge =
              '<span class="inline-flex px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Expired</span>';
          } else if (expDate <= soon) {
            rowClass += " status-expiring";
            statusBadge =
              '<span class="inline-flex px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Expiring Soon</span>';
          } else if (!isNaN(stockLimit) && quantity < stockLimit) {
            rowClass += " status-low-stock";
            statusBadge =
              '<span class="inline-flex px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Low Stock</span>';
          } else {
            statusBadge =
              '<span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Good</span>';
          }

          const row = document.createElement("tr");
          row.className = rowClass;
          row.innerHTML = `
          <td class="py-4 px-6">
            <div class="flex flex-col">
              <span class="font-medium text-gray-900">${escapeHtml(
                item.item_name
              )}</span>
              <div class="mt-1">${statusBadge}</div>
            </div>
          </td>
          <td class="py-4 px-6 text-center">
            <span class="text-2xl font-bold ${
              quantity < stockLimit ? "text-red-600" : "text-gray-900"
            }">${quantity}</span>
          </td>
          <td class="py-4 px-6">
            <span class="${
              expDate < today
                ? "text-red-600 font-medium"
                : expDate <= soon
                ? "text-yellow-600 font-medium"
                : "text-gray-700"
            }">${item.expiry_date}</span>
          </td>
          <td class="py-4 px-6">
            <span class="inline-flex px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">${escapeHtml(
              item.category
            )}</span>
          </td>
          <td class="py-4 px-6 text-center">
            <span class="text-gray-700">${item.stock_limit ?? "–"}</span>
          </td>
          <td class="py-4 px-6">
            <div class="flex flex-col gap-2">
              <button class="edit-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all btn-action" data-id="${
                item.id
              }">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
              </button>
              <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all btn-action" data-id="${
                item.id
              }">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
              </button>
              <button class="use-btn bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all btn-action ${
                quantity <= 0 ? "opacity-50 cursor-not-allowed" : ""
              }" data-id="${item.id}" ${quantity <= 0 ? "disabled" : ""}>
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
                Use
              </button>
            </div>
          </td>
        `;
          tbody.appendChild(row);
        });

        // Attach event listeners
        tbody.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const item = inventory.find((i) => i.id == btn.dataset.id);
            if (item) editItem(item);
          });
        });

        tbody.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            deleteItem(btn.dataset.id);
          });
        });

        tbody.querySelectorAll(".use-btn").forEach((btn) => {
          if (!btn.disabled) {
            btn.addEventListener("click", () => {
              logUsage(btn.dataset.id);
            });
          }
        });

        console.log("Inventory rendered:", itemsToRender.length, "items");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function deleteItem(id) {
        const confirmed = await showConfirm(
          "Are you sure you want to delete this item? This action cannot be undone."
        );
        if (!confirmed) return;

        const itemIndex = inventory.findIndex((i) => i.id == id);
        if (itemIndex === -1) return;

        const item = inventory[itemIndex];

        try {
          const res = await fetch("http://localhost:5000/inventory/del", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({ id }),
          });

          if (res.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (res.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (res.status === 404) {
            window.location.href = "404.html";
            return;
          }

          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.message || "Failed to delete item");
          }

          showSuccess(`Item "${item.item_name}" deleted successfully!`);
          stockLog.push(
            `[${new Date().toLocaleTimeString()}] Deleted: ${item.item_name}`
          );
          await fetchInventory();
          renderLog();
        } catch (error) {
          console.warn("Backend delete failed, removing locally:", error);

          // Remove locally for demo
          inventory.splice(itemIndex, 1);
          renderInventory();
          stockLog.push(
            `[${new Date().toLocaleTimeString()}] Deleted locally: ${
              item.item_name
            }`
          );
          renderLog();

          showError("Deleted locally - backend connection failed");
        }
      }

      async function logUsage(id) {
        const item = inventory.find((i) => i.id == id);
        if (!item || item.quantity <= 0) {
          showError("Item is out of stock!");
          return;
        }

        const newQuantity = item.quantity - 1;

        try {
          const res = await fetch("http://localhost:5000/inventory/usage", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({ id, newQuantity }),
          });

          if (res.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (res.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (res.status === 404) {
            window.location.href = "404.html";
            return;
          }

          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.message || "Failed to update quantity");
          }

          showSuccess(`Used 1 unit of "${item.item_name}"`);
          stockLog.push(
            `[${new Date().toLocaleTimeString()}] Used 1 unit of ${
              item.item_name
            } (Remaining: ${newQuantity})`
          );

          if (item.stock_limit !== null && newQuantity <= item.stock_limit) {
            showError(
              `Warning: "${item.item_name}" is low on stock (Quantity: ${newQuantity})`
            );
          }

          await fetchInventory();
          renderLog();
        } catch (error) {
          console.warn("Backend usage failed, updating locally:", error);

          // Update locally for demo
          item.quantity = newQuantity;
          renderInventory();
          stockLog.push(
            `[${new Date().toLocaleTimeString()}] Used 1 unit of ${
              item.item_name
            } locally (Remaining: ${newQuantity})`
          );
          renderLog();

          if (item.stock_limit !== null && newQuantity <= item.stock_limit) {
            showError(
              `Warning: "${item.item_name}" is low on stock (Quantity: ${newQuantity})`
            );
          }

          showError("Updated locally - backend connection failed");
        }
      }

      let currentEditId = null;

      function editItem(item) {
        currentEditId = item.id;

        // Populate modal fields
        document.getElementById("editItemName").value = item.item_name;
        document.getElementById("editQuantity").value = item.quantity;
        document.getElementById("editExpiryDate").value = item.expiry_date;
        document.getElementById("editCategory").value = item.category;
        document.getElementById("editStockLimit").value =
          item.stock_limit || "";

        // Show modal
        document.getElementById("editModal").classList.remove("hidden");
        document.getElementById("editItemName").focus();
      }

      async function saveEditedItem() {
        if (!currentEditId) return;

        const newName = document.getElementById("editItemName").value.trim();
        const newQuantity = parseInt(
          document.getElementById("editQuantity").value
        );
        const newExpiry = document.getElementById("editExpiryDate").value;
        const newCategory = document.getElementById("editCategory").value;
        const newLimit =
          parseInt(document.getElementById("editStockLimit").value) || null;

        // Validation
        if (
          !newName ||
          isNaN(newQuantity) ||
          newQuantity < 0 ||
          !newExpiry ||
          !newCategory
        ) {
          showError("All fields are required and must be valid.");
          return;
        }

        if (newLimit !== null && (isNaN(newLimit) || newLimit < 0)) {
          showError("Stock limit must be a non-negative number.");
          return;
        }

        try {
          const res = await fetch("http://localhost:5000/inventory/update", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({
              itemId: currentEditId,
              newName,
              newQuantity,
              newExpiry,
              newCategory,
              newLimit,
            }),
          });

          if (res.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (res.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (res.status === 404) {
            window.location.href = "404.html";
            return;
          }

          if (!res.ok) {
            const data = await res.json();
            throw new Error(
              data.error || data.message || "Failed to update item"
            );
          }

          showSuccess(`Item "${newName}" updated successfully!`);
          stockLog.push(
            `[${new Date().toLocaleTimeString()}] Updated: ${newName}`
          );
          closeEditModal();
          await fetchInventory();
          renderLog();
        } catch (error) {
          console.warn("Backend update failed, updating locally:", error);

          // Update locally for demo
          const item = inventory.find((i) => i.id == currentEditId);
          if (item) {
            item.item_name = newName;
            item.quantity = newQuantity;
            item.expiry_date = newExpiry;
            item.category = newCategory;
            item.stock_limit = newLimit;

            renderInventory();
            stockLog.push(
              `[${new Date().toLocaleTimeString()}] Updated locally: ${newName}`
            );
            renderLog();
            closeEditModal();
            showError("Updated locally - backend connection failed");
          }
        }
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
        currentEditId = null;
      }

      function renderLog() {
        const logList = document.getElementById("stockLog");

        if (stockLog.length === 0) {
          logList.innerHTML =
            '<li class="text-gray-500 italic">No recent activity</li>';
          return;
        }

        logList.innerHTML = "";
        stockLog
          .slice(-10)
          .reverse()
          .forEach((entry) => {
            const li = document.createElement("li");
            li.className = "p-2 bg-gray-50 rounded border-l-4 border-blue-400";
            li.textContent = entry;
            logList.appendChild(li);
          });
      }

      function sortAndRender() {
        if (currentSortField) {
          sortInventory(currentSortField, false);
        } else {
          renderInventory();
        }
      }

      // Search and filter functionality
      let allInventory = [];

      function filterInventory() {
        const searchTerm =
          document.getElementById("searchInventory")?.value.toLowerCase() || "";
        const categoryFilter =
          document.getElementById("filterCategory")?.value || "";

        // Start with all items
        let filtered = allInventory.filter((item) => {
          const matchesSearch =
            !searchTerm ||
            item.item_name.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm);

          const matchesCategory =
            !categoryFilter || item.category === categoryFilter;

          return matchesSearch && matchesCategory;
        });

        inventory = filtered;
        sortAndRender(); // Use sortAndRender to maintain sort order
      }

      function clearFilters() {
        const searchInput = document.getElementById("searchInventory");
        const categorySelect = document.getElementById("filterCategory");

        if (searchInput) searchInput.value = "";
        if (categorySelect) categorySelect.value = "";

        inventory = [...allInventory]; // Restore all items
        sortAndRender();
        showSuccess("Filters cleared");
      }

      // Initialize application
      window.addEventListener("DOMContentLoaded", () => {
        console.log("Initializing inventory management...");

        fetchInventory();

        // Profile dropdown functionality
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");
        const logoutBtn = document.getElementById("logoutBtn");

        if (profileBtn && profileDropdown) {
          profileBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle("hidden");
          });

          document.addEventListener("click", (e) => {
            if (
              !profileDropdown.contains(e.target) &&
              !profileBtn.contains(e.target)
            ) {
              profileDropdown.classList.add("hidden");
            }
          });
        }

        // Logout functionality
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            try {
              sessionStorage.clear();
            } catch (error) {
              console.warn("Storage clearing failed:", error);
            }
            window.location.replace("landing.html");
          });
        }

        // Toggle expired filter
        document
          .getElementById("toggleExpiredBtn")
          .addEventListener("click", () => {
            showExpiredOnly = !showExpiredOnly;
            document.getElementById("toggleExpiredBtn").textContent =
              showExpiredOnly ? "Show All Items" : "Show Expired Only";
            document.getElementById("toggleExpiredBtn").className =
              showExpiredOnly
                ? "btn-action bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all font-semibold tracking-wide"
                : "btn-action bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all font-semibold tracking-wide";
            renderInventory();
          });

        // Refresh button
        document.getElementById("refreshBtn").addEventListener("click", () => {
          fetchInventory();
          showSuccess("Inventory refreshed!");
        });

        // Search and filter
        const searchInput = document.getElementById("searchInventory");
        const categorySelect = document.getElementById("filterCategory");
        const sortSelect = document.getElementById("sortBy");

        if (searchInput) {
          let searchTimeout;
          searchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterInventory, 300);
          });
        }

        if (categorySelect) {
          categorySelect.addEventListener("change", filterInventory);
        }

        if (sortSelect) {
          sortSelect.addEventListener("change", (e) => {
            sortInventory(e.target.value, false);
          });
        }

        // Edit modal event listeners
        document
          .getElementById("editCancel")
          .addEventListener("click", closeEditModal);
        document
          .getElementById("editSave")
          .addEventListener("click", saveEditedItem);

        // Close modal on outside click
        document.getElementById("editModal").addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            closeEditModal();
          }
        });

        // Keyboard shortcuts
        document.addEventListener("keydown", function (e) {
          // Escape to close modals
          if (e.key === "Escape") {
            if (
              !document.getElementById("editModal").classList.contains("hidden")
            ) {
              closeEditModal();
            }
          }
        });

        console.log("Inventory management initialized");
      });

      // Make functions globally available
      window.sortInventory = sortInventory;
      window.showConfirm = showConfirm;
    </script>

    <script src="js/navbar.js"></script>
  </body>
</html>
