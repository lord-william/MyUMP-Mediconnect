<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Stock - MediConnect Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Custom animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .stock-item {
        animation: slideIn 0.3s ease-out;
      }

      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* Form focus states */
      .form-input:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }

      /* Enhanced buttons */
      .btn-action {
        transition: all 0.2s ease;
        transform: translateY(0);
      }

      .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 to-indigo-100 text-[#001F3F] font-sans flex flex-col min-h-screen"
  >
    <!-- Navbar -->
    <nav class="bg-white text-black shadow-lg p-4 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a
          href="clinicDashboard.html"
          class="hover:scale-105 transition-transform"
        >
          <img src="media/logo2.png" alt="MediConnect Logo" class="h-20 w-21" />
        </a>
        <div class="hidden md:flex space-x-6">
          <a href="clinicDashboard.html" class="hover:text-blue-600 transition"
            >Dashboard</a
          >
          <a
            href="appointmentManagement.html"
            class="hover:text-blue-600 transition"
            >Appointments</a
          >
          <a
            href="inventoryManagement.html"
            class="hover:text-blue-600 transition font-semibold border-b-2 border-blue-500"
            >Inventory</a
          >
          <a
            href="reporting&analytics.html"
            class="hover:text-blue-600 transition"
            >Reports</a
          >
          <a href="staff_add_tip.html" class="hover:text-blue-600 transition"
            >Add Tips</a
          >
        </div>
        <div class="relative text-sm">
          <span id="userName" class="mr-2 font-medium">Clinic Admin</span>
          <button
            id="profileBtn"
            class="bg-blue-400 text-white rounded-full w-8 h-8 font-bold hover:bg-blue-600 transition-all hover:scale-105"
          >
            MC
          </button>
          <div
            class="absolute right-0 mt-2 w-40 bg-white text-[#001F3F] rounded-lg shadow-xl border hidden"
            id="profileDropdown"
          >
            <a
              href="settings.html"
              class="block px-4 py-2 hover:bg-blue-50 rounded-t-lg transition"
              >Profile Settings</a
            >
            <a
              href="#"
              id="logoutBtn"
              class="block px-4 py-2 text-red-600 hover:bg-red-50 rounded-b-lg transition"
              >Logout</a
            >
          </div>
        </div>
      </div>
    </nav>

    <!-- Notification Containers -->
    <div
      id="errorContainer"
      class="hidden fixed top-4 right-4 max-w-sm bg-red-500 text-white text-sm rounded-xl shadow-lg p-4 flex items-start gap-3 z-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 shrink-0 mt-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span id="errorMessage">Something went wrong</span>
    </div>

    <div
      id="successContainer"
      class="hidden fixed top-4 right-4 max-w-sm bg-green-500 text-white text-sm rounded-xl shadow-lg p-4 flex items-start gap-3 z-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 shrink-0 mt-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        />
      </svg>
      <span id="successMessage">Action completed successfully</span>
    </div>

    <!-- Main Container -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <!-- Page Header -->
        <div class="text-center mb-10">
          <h1 class="text-4xl font-bold text-[#001F3F] mb-2">
            Add Stock to Inventory
          </h1>
          <p class="text-gray-600">Add new items to your medical inventory</p>
          <div class="mt-4">
            <a
              href="inventoryManagement.html"
              class="text-sm text-blue-600 hover:text-blue-800 hover:underline transition"
              >← Back to Inventory Management</a
            >
          </div>
        </div>

        <!-- Add Stock Form -->
        <div
          class="w-full bg-white border border-blue-200 rounded-2xl shadow-xl p-8 mb-10"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-[#001F3F] flex items-center">
              <svg
                class="w-8 h-8 mr-3 text-green-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                ></path>
              </svg>
              Add New Item
            </h2>
          </div>

          <form id="stockForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="itemName"
                  class="block text-sm font-semibold mb-2 text-gray-700"
                >
                  <svg
                    class="w-4 h-4 inline-block mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                    ></path>
                  </svg>
                  Item Name *
                </label>
                <input
                  type="text"
                  id="itemName"
                  placeholder="e.g., Paracetamol Tablets"
                  required
                  maxlength="100"
                  class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                />
                <div class="text-xs text-gray-500 mt-1">Max 100 characters</div>
              </div>

              <div>
                <label
                  for="category"
                  class="block text-sm font-semibold mb-2 text-gray-700"
                >
                  <svg
                    class="w-4 h-4 inline-block mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                    ></path>
                  </svg>
                  Category *
                </label>
                <select
                  id="category"
                  required
                  class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
                  <option value="">Select a category</option>
                  <option value="Equipment">Equipment</option>
                  <option value="Medication">Medication</option>
                  <option value="PPE">
                    PPE (Personal Protective Equipment)
                  </option>
                  <option value="Consumables">Consumables</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label
                  for="quantity"
                  class="block text-sm font-semibold mb-2 text-gray-700"
                >
                  <svg
                    class="w-4 h-4 inline-block mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"
                    ></path>
                  </svg>
                  Quantity *
                </label>
                <input
                  type="number"
                  id="quantity"
                  placeholder="e.g., 100"
                  required
                  min="1"
                  class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                />
                <div class="text-xs text-gray-500 mt-1">
                  Must be greater than 0
                </div>
              </div>

              <div>
                <label
                  for="stockLimit"
                  class="block text-sm font-semibold mb-2 text-gray-700"
                >
                  <svg
                    class="w-4 h-4 inline-block mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  Low Stock Alert Limit *
                </label>
                <input
                  type="number"
                  id="stockLimit"
                  placeholder="e.g., 20"
                  required
                  min="0"
                  class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                />
                <div class="text-xs text-gray-500 mt-1">
                  Alert when stock falls below this number
                </div>
              </div>

              <div>
                <label
                  for="expiryDate"
                  class="block text-sm font-semibold mb-2 text-gray-700"
                >
                  <svg
                    class="w-4 h-4 inline-block mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                    ></path>
                  </svg>
                  Expiry Date *
                </label>
                <input
                  type="date"
                  id="expiryDate"
                  required
                  class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                />
                <div class="text-xs text-gray-500 mt-1">
                  Item expiration date
                </div>
              </div>
            </div>

            <div class="flex gap-4">
              <button
                type="submit"
                id="submitBtn"
                class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-all font-semibold tracking-wide disabled:opacity-60 disabled:cursor-not-allowed hover:shadow-lg transform hover:-translate-y-0.5 btn-action"
              >
                <svg
                  class="w-5 h-5 inline-block mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Add Item to Inventory
              </button>
              <button
                type="button"
                id="clearBtn"
                class="bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold tracking-wide hover:shadow-lg transform hover:-translate-y-0.5 btn-action"
              >
                <svg
                  class="w-5 h-5 inline-block mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
                Clear Form
              </button>
            </div>
          </form>
        </div>

        <!-- Current Inventory Display -->
        <div
          class="w-full bg-white border border-blue-200 rounded-2xl shadow-xl p-8"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-[#001F3F] flex items-center">
              <svg
                class="w-7 h-7 mr-3 text-blue-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
              Recently Added Items
            </h2>
            <div class="flex gap-2">
              <button
                id="refreshTableBtn"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all text-sm font-medium btn-action"
              >
                <svg
                  class="w-4 h-4 inline-block mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
                Refresh
              </button>
              <div
                id="itemCount"
                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"
              >
                0 items
              </div>
            </div>
          </div>

          <!-- Search functionality -->
          <div class="mb-6">
            <input
              id="searchItems"
              type="text"
              placeholder="Search items by name or category..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <!-- Table -->
          <div class="overflow-x-auto custom-scrollbar">
            <table class="min-w-full text-sm text-left text-[#001F3F]">
              <thead class="bg-gray-50 text-gray-700 border-b border-gray-200">
                <tr>
                  <th class="py-4 px-6">Item Name</th>
                  <th class="py-4 px-6 text-center">Quantity</th>
                  <th class="py-4 px-6 text-center">Stock Limit</th>
                  <th class="py-4 px-6">Expiry Date</th>
                  <th class="py-4 px-6">Category</th>
                  <th class="py-4 px-6 text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTable" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="6" class="text-center py-12">
                    <div class="text-gray-500">
                      <svg
                        class="mx-auto h-12 w-12 text-gray-400 mb-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4m16 0l-2-2m-2 2l2-2m0 0l-2-2m2 2l2 2M8 13V9"
                        ></path>
                      </svg>
                      <p class="text-lg font-medium">No items found</p>
                      <p class="text-sm">Add some items to see them here</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 text-white text-center py-6 text-sm mt-10">
      <p>© 2025 MediConnect. All rights reserved.</p>
      <p>Email: campusclinic@ump.ac.za | Phone: +27 76 049 6387</p>
    </footer>

    <!-- Enhanced Confirm Modal -->
    <div
      id="confirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-96 p-6 text-center transform transition-all"
      >
        <div class="mb-4">
          <svg
            class="mx-auto h-16 w-16 text-red-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-4 text-gray-800" id="confirmMessage">
          Are you sure?
        </h2>
        <div class="flex justify-center gap-4">
          <button
            id="confirmYes"
            class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all font-semibold"
          >
            Yes, Delete
          </button>
          <button
            id="confirmNo"
            class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-all font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      // Remove browser storage dependency and replace with in-memory storage
      function getToken() {
        try {
          return (
            sessionStorage.getItem("supabase_token") ||
            "mock_token_for_development"
          );
        } catch (error) {
          console.warn("SessionStorage not available, using mock token");
          return "mock_token_for_development";
        }
      }

      // Notification Functions
      function showError(message, duration = 4000) {
        const container = document.getElementById("errorContainer");
        const msg = document.getElementById("errorMessage");
        if (container && msg) {
          msg.textContent = message;
          container.classList.remove("hidden");
          setTimeout(() => container.classList.add("hidden"), duration);
        } else {
          console.error("Error:", message);
        }
      }

      function showSuccess(message, duration = 4000) {
        const container = document.getElementById("successContainer");
        const msg = document.getElementById("successMessage");
        if (container && msg) {
          msg.textContent = message;
          container.classList.remove("hidden");
          setTimeout(() => container.classList.add("hidden"), duration);
        } else {
          console.log("Success:", message);
        }
      }

      // Confirmation modal
      function showConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmModal");
          const messageEl = document.getElementById("confirmMessage");
          const yesBtn = document.getElementById("confirmYes");
          const noBtn = document.getElementById("confirmNo");

          if (!modal || !messageEl || !yesBtn || !noBtn) {
            resolve(confirm(message));
            return;
          }

          messageEl.textContent = message;
          modal.classList.remove("hidden");

          const handleYes = () => {
            modal.classList.add("hidden");
            yesBtn.removeEventListener("click", handleYes);
            noBtn.removeEventListener("click", handleNo);
            resolve(true);
          };

          const handleNo = () => {
            modal.classList.add("hidden");
            yesBtn.removeEventListener("click", handleYes);
            noBtn.removeEventListener("click", handleNo);
            resolve(false);
          };

          yesBtn.addEventListener("click", handleYes);
          noBtn.addEventListener("click", handleNo);
        });
      }

      // Inventory management
      let currentInventory = [];

      // Mock data for development
      const mockItems = [
        {
          id: 1,
          item_name: "Paracetamol Tablets",
          quantity: 150,
          stock_limit: 50,
          expiry_date: "2025-06-15",
          category: "Medication",
        },
        {
          id: 2,
          item_name: "Digital Thermometer",
          quantity: 8,
          stock_limit: 10,
          expiry_date: "2027-12-31",
          category: "Equipment",
        },
      ];

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Form submission handler
      const form = document.getElementById("stockForm");
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const itemName = document.getElementById("itemName").value.trim();
        const quantity = parseInt(document.getElementById("quantity").value);
        const stockLimit = parseInt(
          document.getElementById("stockLimit").value
        );
        const expiryDate = document.getElementById("expiryDate").value;
        const category = document.getElementById("category").value.trim();
        const submitBtn = document.getElementById("submitBtn");

        // Validation
        if (
          !itemName ||
          isNaN(quantity) ||
          isNaN(stockLimit) ||
          !expiryDate ||
          !category
        ) {
          showError("All fields are required and must be valid.");
          return;
        }

        if (quantity <= 0) {
          showError("Quantity must be greater than 0.");
          return;
        }

        if (stockLimit < 0) {
          showError("Stock limit must be 0 or greater.");
          return;
        }

        // Check if expiry date is in the past
        const today = new Date();
        const expiry = new Date(expiryDate);
        if (expiry < today) {
          showError("Expiry date cannot be in the past.");
          return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = "Adding Item...";

        try {
          const response = await fetch("http://localhost:5000/add_stock/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({
              itemName,
              quantity,
              expiryDate,
              stockLimit,
              category,
            }),
          });

          if (response.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (response.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (response.status === 404) {
            window.location.href = "404.html";
            return;
          }

          const result = await response.json();

          if (response.ok && result.success) {
            addRowToTable(result.inserted);
            showSuccess("Item added successfully!");
            form.reset();
            updateItemCount();
          } else {
            console.error("Insert failed:", result.error);
            showError(
              "Failed to add item: " + (result.error || "Unknown error")
            );
          }
        } catch (error) {
          console.warn("Backend request failed, adding locally:", error);

          // Add locally for demo
          const newItem = {
            id: Date.now(),
            item_name: itemName,
            quantity: quantity,
            stock_limit: stockLimit,
            expiry_date: expiryDate,
            category: category,
          };

          addRowToTable(newItem);
          showSuccess("Item added locally!");
          showError("Added locally - backend connection failed");
          form.reset();
          updateItemCount();
        }

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Add Item to Inventory
      `;
      });

      function addRowToTable(item) {
        const tableBody = document.getElementById("inventoryTable");

        // Remove "no items" message if present
        if (tableBody.querySelector('td[colspan="6"]')) {
          tableBody.innerHTML = "";
        }

        const today = new Date();
        const expiry = new Date(item.expiry_date);
        const isExpired = expiry < today;
        const isExpiringSoon =
          expiry <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        const isLowStock = item.quantity < item.stock_limit;

        let statusBadge = "";
        let rowClass = "stock-item";

        if (isExpired) {
          statusBadge =
            '<span class="inline-flex px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Expired</span>';
          rowClass += " bg-red-50";
        } else if (isExpiringSoon) {
          statusBadge =
            '<span class="inline-flex px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Expiring Soon</span>';
          rowClass += " bg-yellow-50";
        } else if (isLowStock) {
          statusBadge =
            '<span class="inline-flex px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Low Stock</span>';
          rowClass += " bg-orange-50";
        } else {
          statusBadge =
            '<span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Good</span>';
        }

        const row = document.createElement("tr");
        row.className = rowClass;
        row.setAttribute("data-id", item.id);
        row.innerHTML = `
        <td class="py-4 px-6">
          <div class="flex flex-col">
            <span class="font-medium text-gray-900">${escapeHtml(
              item.item_name
            )}</span>
            <div class="mt-1">${statusBadge}</div>
          </div>
        </td>
        <td class="py-4 px-6 text-center">
          <span class="text-lg font-semibold ${
            isLowStock ? "text-red-600" : "text-gray-900"
          }">${item.quantity}</span>
        </td>
        <td class="py-4 px-6 text-center">
          <span class="text-gray-700">${item.stock_limit}</span>
        </td>
        <td class="py-4 px-6">
          <span class="${
            isExpired
              ? "text-red-600 font-medium"
              : isExpiringSoon
              ? "text-yellow-600 font-medium"
              : "text-gray-700"
          }">${item.expiry_date}</span>
        </td>
        <td class="py-4 px-6">
          <span class="inline-flex px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">${escapeHtml(
            item.category
          )}</span>
        </td>
        <td class="py-4 px-6 text-center">
          <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all btn-action">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete
          </button>
        </td>
      `;

        const deleteBtn = row.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", () => removeRow(item.id));

        // Add to beginning of table (most recent first)
        if (tableBody.firstChild) {
          tableBody.insertBefore(row, tableBody.firstChild);
        } else {
          tableBody.appendChild(row);
        }

        // Add to current inventory for tracking
        currentInventory.unshift(item);
      }

      async function removeRow(itemId) {
        const confirmed = await showConfirm(
          "Are you sure you want to delete this item?"
        );
        if (!confirmed) return;

        const row = document.querySelector(`tr[data-id="${itemId}"]`);
        if (!row) return;

        const itemName = row.querySelector("td .font-medium").textContent;

        try {
          const res = await fetch("http://localhost:5000/add_stock/del", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({ itemId }),
          });

          if (res.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (res.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (res.status === 404) {
            window.location.href = "404.html";
            return;
          }

          const data = await res.json();

          if (!res.ok) {
            console.error("Error deleting item:", data.error || data.message);
            showError(`Error: ${data.error || data.message}`);
            return;
          }

          showSuccess(`Item "${itemName}" deleted successfully!`);
        } catch (error) {
          console.warn("Backend delete failed, removing locally:", error);
          showError("Deleted locally - backend connection failed");
        }

        // Remove from DOM and current inventory
        row.remove();
        currentInventory = currentInventory.filter((item) => item.id != itemId);
        updateItemCount();

        // Show "no items" message if table is empty
        const tableBody = document.getElementById("inventoryTable");
        if (!tableBody.children.length) {
          tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-12">
              <div class="text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4m16 0l-2-2m-2 2l2-2m0 0l-2-2m2 2l2 2M8 13V9"></path>
                </svg>
                <p class="text-lg font-medium">No items found</p>
                <p class="text-sm">Add some items to see them here</p>
              </div>
            </td>
          </tr>
        `;
        }
      }

      async function loadInventory() {
        try {
          const res = await fetch("http://localhost:5000/add_stock/load", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
          });

          if (res.status === 401) {
            window.location.href = "401.html";
            return;
          }
          if (res.status === 403) {
            window.location.href = "403.html";
            return;
          }
          if (res.status === 404) {
            window.location.href = "404.html";
            return;
          }

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "Failed to load inventory");
          }

          const tableBody = document.getElementById("inventoryTable");
          tableBody.innerHTML = "";
          currentInventory = [];

          data.forEach((item) => {
            addRowToTable(item);
          });

          updateItemCount();
        } catch (error) {
          console.warn("Backend load failed, using mock data:", error);

          // Use mock data for demo
          const tableBody = document.getElementById("inventoryTable");
          tableBody.innerHTML = "";
          currentInventory = [];

          mockItems.forEach((item) => {
            addRowToTable(item);
          });

          updateItemCount();
          showError("Using demo data - backend connection failed");
        }
      }

      function updateItemCount() {
        const itemCountEl = document.getElementById("itemCount");
        const count = currentInventory.length;
        itemCountEl.textContent = `${count} item${count !== 1 ? "s" : ""}`;
      }

      // Search functionality
      function filterTable() {
        const searchTerm = document
          .getElementById("searchItems")
          .value.toLowerCase();
        const rows = document.querySelectorAll(
          "#inventoryTable tr:not([colspan])"
        );

        let visibleCount = 0;
        rows.forEach((row) => {
          const itemName =
            row.querySelector(".font-medium")?.textContent.toLowerCase() || "";
          const category =
            row.querySelector(".bg-blue-100")?.textContent.toLowerCase() || "";

          const matches =
            itemName.includes(searchTerm) || category.includes(searchTerm);

          if (matches) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        // Update count to show filtered results
        const itemCountEl = document.getElementById("itemCount");
        const totalCount = currentInventory.length;
        if (searchTerm) {
          itemCountEl.textContent = `${visibleCount} of ${totalCount} items`;
        } else {
          itemCountEl.textContent = `${totalCount} item${
            totalCount !== 1 ? "s" : ""
          }`;
        }
      }

      // Initialize application
      window.addEventListener("DOMContentLoaded", () => {
        console.log("Initializing add stock page...");

        // Load existing inventory
        loadInventory();

        // Profile dropdown functionality
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");
        const logoutBtn = document.getElementById("logoutBtn");

        if (profileBtn && profileDropdown) {
          profileBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle("hidden");
          });

          document.addEventListener("click", (e) => {
            if (
              !profileDropdown.contains(e.target) &&
              !profileBtn.contains(e.target)
            ) {
              profileDropdown.classList.add("hidden");
            }
          });
        }

        // Logout functionality
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            try {
              sessionStorage.clear();
            } catch (error) {
              console.warn("Storage clearing failed:", error);
            }
            window.location.replace("landing.html");
          });
        }

        // Clear form button
        const clearBtn = document.getElementById("clearBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            form.reset();
            showSuccess("Form cleared");
          });
        }

        // Refresh table button
        const refreshTableBtn = document.getElementById("refreshTableBtn");
        if (refreshTableBtn) {
          refreshTableBtn.addEventListener("click", () => {
            loadInventory();
            showSuccess("Table refreshed");
          });
        }

        // Search functionality
        const searchInput = document.getElementById("searchItems");
        if (searchInput) {
          let searchTimeout;
          searchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterTable, 300);
          });
        }

        // Set minimum date to today for expiry date
        const expiryDateInput = document.getElementById("expiryDate");
        if (expiryDateInput) {
          const today = new Date().toISOString().split("T")[0];
          expiryDateInput.setAttribute("min", today);
        }

        // Character counters
        const itemNameInput = document.getElementById("itemName");
        if (itemNameInput) {
          itemNameInput.addEventListener("input", (e) => {
            const remaining = 100 - e.target.value.length;
            const counter = e.target.parentNode.querySelector(".text-xs");
            if (counter) {
              counter.textContent = `${remaining} characters remaining`;
              counter.className =
                remaining < 20
                  ? "text-xs text-red-500 mt-1"
                  : "text-xs text-gray-500 mt-1";
            }
          });
        }

        // Quantity validation
        const quantityInput = document.getElementById("quantity");
        if (quantityInput) {
          quantityInput.addEventListener("input", (e) => {
            const value = parseInt(e.target.value);
            if (value <= 0) {
              e.target.setCustomValidity("Quantity must be greater than 0");
            } else {
              e.target.setCustomValidity("");
            }
          });
        }

        // Stock limit validation
        const stockLimitInput = document.getElementById("stockLimit");
        if (stockLimitInput) {
          stockLimitInput.addEventListener("input", (e) => {
            const value = parseInt(e.target.value);
            if (value < 0) {
              e.target.setCustomValidity("Stock limit cannot be negative");
            } else {
              e.target.setCustomValidity("");
            }
          });
        }

        // Keyboard shortcuts
        document.addEventListener("keydown", function (e) {
          // Ctrl/Cmd + Enter to submit form
          if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
            const submitBtn = document.getElementById("submitBtn");
            if (submitBtn && !submitBtn.disabled) {
              form.dispatchEvent(new Event("submit"));
            }
          }

          // Escape to clear form
          if (e.key === "Escape") {
            const clearBtn = document.getElementById("clearBtn");
            if (clearBtn) {
              clearBtn.click();
            }
          }
        });

        console.log("Add stock page initialized");
      });

      // Make functions globally available
      window.showConfirm = showConfirm;
      window.loadInventory = loadInventory;
    </script>

    <script src="js/navbar.js"></script>
  </body>
</html>
